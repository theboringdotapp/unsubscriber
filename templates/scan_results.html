{% extends 'base.html' %}

{% block title %}Scan Results - Gmail Unsubscriber{% endblock %}

{% block head_extra %}
<style>
    /* Checkmark animation styles */
    .checkmark-container {
        width: 80px;
        height: 80px;
        position: relative;
    }
    
    .checkmark {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: block;
        stroke-width: 2;
        stroke: #1a7f37;
        stroke-miterlimit: 10;
        box-shadow: inset 0px 0px 0px #1a7f37;
        animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
    }
    
    .checkmark-circle {
        stroke-dasharray: 166;
        stroke-dashoffset: 166;
        stroke-width: 2;
        stroke-miterlimit: 10;
        stroke: #1a7f37;
        fill: none;
        animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }
    
    .checkmark-check {
        transform-origin: 50% 50%;
        stroke-dasharray: 48;
        stroke-dashoffset: 48;
        animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }
    
    @keyframes stroke {
        100% {
            stroke-dashoffset: 0;
        }
    }
    
    @keyframes scale {
        0%, 100% {
            transform: none;
        }
        50% {
            transform: scale3d(1.1, 1.1, 1);
        }
    }
    
    @keyframes fill {
        100% {
            box-shadow: inset 0px 0px 0px 30px #eaffef;
        }
    }
    
    /* Modal overlay */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
    }
    
    .modal-hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="card-bg rounded-lg overflow-hidden">
    <div class="px-6 py-4 border-b border-[var(--border-color)]">
        <h1 class="text-2xl font-semibold">Potential Unsubscribe Emails</h1>
    </div>

    {% if emails %}
        <form class="action-form" id="unsubscribe-form" action="{{ url_for('unsubscribe_and_archive') }}" method="post" onsubmit="handleUnsubscribeSubmit(event)">
            <input type="hidden" name="final_email_ids" id="final-email-ids">
            <input type="hidden" name="final_unsubscribe_links" id="final-unsubscribe-links">

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-[var(--border-color)]">
                    <thead>
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider w-12">
                                <input type="checkbox" id="select-all-checkbox" title="Select/Deselect All" class="form-checkbox h-4 w-4 rounded text-[var(--accent-color)] focus:ring-[var(--accent-color)]">
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider">Sender</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider">Subject</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider">Unsubscribe Link</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-[var(--border-color)]" id="email-list-body">
                        {% for email in emails %}
                        <tr data-sender="{{ email.sender | escape }}" data-id="{{ email.id }}" data-link="{{ email.unsubscribe_link }}" class="hover:bg-[var(--hover-bg)] clickable-row">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="checkbox" name="email_ids_page" value="{{ email.id }}" onclick="handleSingleCheckboxClick(this)" class="form-checkbox h-4 w-4 rounded text-[var(--accent-color)] focus:ring-[var(--accent-color)] item-checkbox">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-[var(--text-primary)]">{{ email.sender }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-[var(--text-primary)] truncate" title="{{ email.subject }}">{{ email.subject }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-[var(--text-secondary)]">
                                <a href="{{ email.unsubscribe_link }}" target="_blank" class="text-[var(--accent-color)] hover:text-[var(--accent-hover)] hover:underline text-xs email-link" title="{{ email.unsubscribe_link }}">Visit Link</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% if next_page_token %}
            <div class="px-6 py-4 text-right">
                <a href="{{ url_for('scan_emails', token=next_page_token) }}" 
                   id="next-page-button" 
                   onclick="setLoading('next-page-button', 'Loading...')" 
                   class="glass-button inline-flex items-center px-4 py-2 text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--accent-color)]">
                    Next Page
                </a>
            </div>
            {% endif %}
        </form>
    {% else %}
        <div class="px-6 py-4">
            <p class="text-[var(--text-secondary)]">No emails found with unsubscribe links in this batch or in your inbox.</p>
             <a href="{{ url_for('index') }}" class="mt-4 inline-block text-[var(--accent-color)] hover:text-[var(--accent-hover)] hover:underline">Back to Home</a>
        </div>
    {% endif %}
</div>

<!-- Modal for unsubscribe results -->
<div id="result-modal" class="modal-overlay modal-hidden">
    <div id="unsubscribe-results" class="bg-white rounded-lg p-6 shadow-xl max-w-md w-full">
        <!-- Content will be replaced by the AJAX response -->
    </div>
</div>

<!-- Spacer div that will dynamically adjust its height when the action bar appears -->
<div id="footer-spacer" class="h-0 transition-all duration-200"></div>

{# Define the action bar content here, NOT hidden initially, to be moved by JS #}
{# The outer bar (#fixed-action-bar in base.html) controls visibility #}
<div id="fixed-action-bar-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-end flex-wrap gap-4">
    <button type="submit" 
            form="unsubscribe-form" 
            id="unsubscribe-button" 
            class="inline-flex items-center justify-center px-5 py-2 text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--accent-color)] bg-gradient-to-r from-[#0969da] to-[#8250df] text-white hover:translate-y-[-2px] hover:shadow-md transition-all duration-200" 
            disabled>
        Unsubscribe & Archive <span id="selected-count" class="font-bold mx-1">0</span> Emails
    </button>
</div>

{% endblock %}

{% block scripts %}
<script>
    const storageKey = 'selectedEmails';
    let fixedActionBar = null;      // Initialize as null, find on DOMContentLoaded
    let actionBarContent = null;    // Initialize as null
    let selectedCountSpan = null;   // Initialize as null
    let selectAllCheckbox = null;   // Initialize as null
    let itemCheckboxes = [];        // Initialize as empty array
    let unsubscribeButton = null;   // Initialize as null
    let emailListBody = null;       // Initialize as null
    let footerSpacer = null;        // Initialize as null
    let resultModal = null;         // Initialize as null
    let processedEmailIds = new Set(); // Track processed emails

    // --- Storage Management ---
    function getSelectedEmails() {
        const stored = sessionStorage.getItem(storageKey);
        try {
            return stored ? JSON.parse(stored) : {}; // Store as {id: link}
        } catch (e) {
            console.error("Error parsing selectedEmails from sessionStorage:", e);
            return {}; // Return empty object on error
        }
    }

    function saveSelectedEmails(emails) {
        try {
            sessionStorage.setItem(storageKey, JSON.stringify(emails));
        } catch (e) {
            console.error("Error saving selectedEmails to sessionStorage:", e);
        }
    }

    function updateSelectionStorage(emailId, link, isSelected) {
        const selectedEmails = getSelectedEmails();
        if (isSelected) {
            selectedEmails[emailId] = link;
        } else {
            delete selectedEmails[emailId];
        }
        saveSelectedEmails(selectedEmails);
    }

    // --- UI Updates ---
    function updateFixedFooter() {
        console.log("updateFixedFooter called");
        if (!fixedActionBar || !unsubscribeButton) {
            console.error("Cannot update footer - fixedActionBar or unsubscribeButton not found.");
            return;
        }

        const selectedEmails = getSelectedEmails();
        const count = Object.keys(selectedEmails).length;
        console.log("Selected count:", count);

        // Rebuild the button content with improved label
        const emailText = count === 1 ? "Email" : "Emails";
        const buttonContent = `Unsubscribe & Archive <span id="selected-count" class="font-bold mx-1">${count}</span> ${emailText}`;
        // Set the entire innerHTML of the button
        unsubscribeButton.innerHTML = buttonContent;
        console.log("Updated button innerHTML");

        if (count > 0) {
            console.log("Showing fixed footer");
            fixedActionBar.classList.remove('hidden');
            unsubscribeButton.disabled = false;
            
            // Adjust the spacer height to match the action bar height
            if (footerSpacer) {
                // Get the height of the action bar
                const actionBarHeight = fixedActionBar.offsetHeight;
                footerSpacer.style.height = actionBarHeight + 'px';
            }
        } else {
            console.log("Hiding fixed footer");
            fixedActionBar.classList.add('hidden');
            unsubscribeButton.disabled = true;
            
            // Reset spacer height when action bar is hidden
            if (footerSpacer) {
                footerSpacer.style.height = '0';
            }
        }
    }

    function loadSelectionFromStorage() {
        console.log("loadSelectionFromStorage called");
        const selectedEmails = getSelectedEmails();
        let allVisibleChecked = itemCheckboxes.length > 0;
        itemCheckboxes.forEach(checkbox => {
            const emailId = checkbox.value;
            checkbox.checked = selectedEmails.hasOwnProperty(emailId);
            if (!checkbox.checked) {
                allVisibleChecked = false;
            }
        });
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = allVisibleChecked;
        }
    }

    // --- Event Handlers ---
    function handleSingleCheckboxClick(checkbox) {
        console.log("handleSingleCheckboxClick called for:", checkbox.value, "Checked:", checkbox.checked);
        const row = checkbox.closest('tr');
        if (!row) {
            console.error("Could not find parent row for checkbox", checkbox);
            return;
        }
        const emailId = row.dataset.id;
        const link = row.dataset.link;
        if (!emailId || link === undefined) {
             console.error("Missing data-id or data-link on row", row);
             return;
        }

        updateSelectionStorage(emailId, link, checkbox.checked);
        updateFixedFooter(); // Update footer visibility and count

        // Update Select All state
        let allVisibleChecked = true;
        itemCheckboxes.forEach(cb => {
            if (!cb.checked) allVisibleChecked = false;
        });
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = allVisibleChecked;
        }

        // Trigger sender selection logic if the box was checked
        if (checkbox.checked) {
            handleSenderSelection(checkbox, row.dataset.sender);
        }
    }

    // Row click handler
    function handleRowClick(event) {
        console.log("Row click listener fired. Target:", event.target);
        const row = event.target.closest('tr.clickable-row');
        if (!row) {
            console.log("Row click: Not inside a clickable row.");
            return;
        }
        console.log("Row click: Found row:", row);

        if (event.target.matches('input.item-checkbox, a.email-link, a.email-link *')) {
            console.log("Row click: Click was on checkbox or link, ignoring.");
            return;
        }

        const checkbox = row.querySelector('.item-checkbox');
        if (checkbox) {
            console.log("Row click: Found checkbox, toggling and calling handler.");
            checkbox.checked = !checkbox.checked;
            handleSingleCheckboxClick(checkbox); // Call the main handler
        } else {
            console.error("Row click: Could not find checkbox in row:", row);
        }
    }

    // Select All handler
    function handleSelectAllChange(event) {
        console.log("Select All changed to:", event.target.checked);
        const isChecked = event.target.checked;
        itemCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
            const row = checkbox.closest('tr');
            const emailId = row.dataset.id;
            const link = row.dataset.link;
            updateSelectionStorage(emailId, link, isChecked);
        });
        updateFixedFooter(); // Update footer after processing all
    }

    // Form submission handler - Now with AJAX
    function handleUnsubscribeSubmit(event) {
        event.preventDefault(); // Prevent normal form submission
        
        const selectedEmails = getSelectedEmails();
        const ids = Object.keys(selectedEmails);
        const links = Object.values(selectedEmails);

        document.getElementById('final-email-ids').value = ids.join(',');
        document.getElementById('final-unsubscribe-links').value = links.join(',,,,,'); // Use five commas as delimiter to avoid URL conflicts

        if (ids.length === 0) {
            alert("Please select at least one email to unsubscribe.");
            return false;
        }
        
        // Store processed IDs for later removal
        ids.forEach(id => processedEmailIds.add(id));
        
        // Show loading state
        setLoading('unsubscribe-button', 'Unsubscribing...');
        
        // Show the modal immediately with a loading state
        if (resultModal) {
            document.getElementById('unsubscribe-results').innerHTML = `
                <div class="text-center">
                    <div class="inline-block rounded-full border-4 border-t-transparent border-[var(--accent-color)] border-solid h-12 w-12 animate-spin mb-4"></div>
                    <p class="text-gray-600">Processing your request...</p>
                </div>
            `;
            resultModal.classList.remove('modal-hidden');
        }
        
        // Submit the form with AJAX
        const form = document.getElementById('unsubscribe-form');
        const formData = new FormData(form);
        
        // Add a header to indicate this is an AJAX/HTMX request
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'HX-Request': 'true' // This tells the server it's an HTMX request
            }
        })
        .then(response => response.text())
        .then(html => {
            // Show the result modal with the response HTML
            if (resultModal) {
                document.getElementById('unsubscribe-results').innerHTML = html;
            }
            
            // Reset loading state
            if (unsubscribeButton) {
                hideLoading('unsubscribe-button');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            
            // Show error in the modal
            if (resultModal) {
                document.getElementById('unsubscribe-results').innerHTML = `
                    <div class="bg-white rounded-lg p-6 text-center flex flex-col items-center">
                        <div class="error-container mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-red-600 mb-2">Error</h3>
                        <p class="text-gray-600">An error occurred while processing your request.</p>
                        <button class="mt-4 px-4 py-2 bg-[var(--accent-color)] text-white rounded-md hover:bg-[var(--accent-hover)]" onclick="window.closeErrorMessage()">Close</button>
                    </div>
                `;
            }
            
            // Reset loading state
            if (unsubscribeButton) {
                hideLoading('unsubscribe-button');
            }
        });
    }
    
    // Function to remove processed emails from list
    function removeProcessedEmails() {
        console.log("removeProcessedEmails called");
        if (processedEmailIds.size === 0) {
            // No emails to remove
            if (resultModal) {
                resultModal.classList.add('modal-hidden');
            }
            return;
        }
        
        // Remove rows for processed emails
        processedEmailIds.forEach(emailId => {
            const row = document.querySelector(`tr[data-id="${emailId}"]`);
            if (row) {
                // Add animation class
                row.classList.add('fade-out');
                // Remove from the DOM after animation completes
                setTimeout(() => {
                    row.remove();
                }, 500);
                
                // Also remove from storage
                const selectedEmails = getSelectedEmails();
                delete selectedEmails[emailId];
                saveSelectedEmails(selectedEmails);
            }
        });
        
        // Clear processed IDs
        processedEmailIds.clear();
        
        // Update button state
        updateFixedFooter();
        
        // Hide modal
        if (resultModal) {
            resultModal.classList.add('modal-hidden');
        }
    }
    
    // Function to close error message
    function closeErrorMessage() {
        console.log("closeErrorMessage called");
        if (resultModal) {
            resultModal.classList.add('modal-hidden');
        }
    }

    // --- Sender Selection Handler (no changes needed here for counter/visibility) ---
    function handleSenderSelection(checkbox, sender) {
        const selectedEmails = getSelectedEmails(); // Get current state
        const decodedSender = sender.replace(/&amp;/g, "&").replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&quot;/g, '"').replace(/&#39;/g, "'");

        // This function is now called only *after* the initial checkbox is checked and storage updated
        // So we just need to check if there are *other* emails to prompt for

        const senderRows = emailListBody.querySelectorAll(`tr[data-sender="${sender}"]`);
        const senderCheckboxes = [];
        let uncheckedCount = 0;
        senderRows.forEach(row => {
            const cb = row.querySelector('input[type="checkbox"]');
            if (cb && cb !== checkbox && !cb.checked) {
                 uncheckedCount++;
            }
            if(cb) senderCheckboxes.push(cb); // Collect all checkboxes for this sender
        });


        if (uncheckedCount > 0) {
            const totalFromSender = senderCheckboxes.length;
            const message = `You selected an email from ${decodedSender}.\n\nThere are ${totalFromSender} email(s) from this sender in the list.\n\nDo you want to select all ${totalFromSender} emails from ${decodedSender}?`;

            if (window.confirm(message)) {
                senderCheckboxes.forEach(cb => {
                    if (!cb.checked) {
                        cb.checked = true;
                        // Update storage for newly checked items
                        const row = cb.closest('tr');
                        const emailId = row.dataset.id;
                        const link = row.dataset.link;
                        selectedEmails[emailId] = link; // Add to our local copy
                    }
                });
                saveSelectedEmails(selectedEmails); // Save the updated batch
                updateFixedFooter(); // Update footer count/visibility

                // Update Select All state if necessary
                let allVisibleChecked = true;
                itemCheckboxes.forEach(cb => { if (!cb.checked) allVisibleChecked = false; });
                if (selectAllCheckbox) selectAllCheckbox.checked = allVisibleChecked;
            }
        }
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded event fired");
        console.log("Document Referrer:", document.referrer); // DEBUG

        // Find elements *after* DOM is loaded
        fixedActionBar = document.getElementById('fixed-action-bar');
        actionBarContent = document.getElementById('fixed-action-bar-content');
        footerSpacer = document.getElementById('footer-spacer');
        resultModal = document.getElementById('result-modal');
        // selectedCountSpan will be found inside updateFixedFooter
        selectAllCheckbox = document.getElementById('select-all-checkbox');
        itemCheckboxes = document.querySelectorAll('.item-checkbox');
        unsubscribeButton = document.getElementById('unsubscribe-button');
        emailListBody = document.getElementById('email-list-body');

        // Verify crucial elements needed for setup
        if (!fixedActionBar) console.error("#fixed-action-bar not found!");
        if (!actionBarContent) console.error("#fixed-action-bar-content not found!");
        if (!emailListBody) console.error("#email-list-body not found!");
        if (!footerSpacer) console.error("#footer-spacer not found!");
        if (!resultModal) console.error("#result-modal not found!");
        // unsubscribeButton check is implicitly done in updateFixedFooter

        // *** Check if this is a page refresh/initial load vs pagination ***
        const referrerUrl = document.referrer ? new URL(document.referrer) : null;
        const currentUrl = new URL(window.location.href);
        const isPagination = referrerUrl && referrerUrl.pathname === currentUrl.pathname; // Came from /scan

        if (!isPagination) {
            console.log("Referrer is not /scan or no referrer. Clearing selection storage.");
            sessionStorage.removeItem(storageKey);
        } else {
            console.log("Referrer is /scan. Assuming pagination, keeping selection storage.");
        }

        // Move content to fixed bar (do this before updating footer)
        if (fixedActionBar && actionBarContent && !fixedActionBar.contains(actionBarContent)) {
            console.log("Moving actionBarContent to fixedActionBar on load");
            fixedActionBar.appendChild(actionBarContent);
        } else if (fixedActionBar && fixedActionBar.contains(actionBarContent)) {
            console.log("actionBarContent already in fixedActionBar on load");
        }

        // Add event listeners
        if (emailListBody) {
            emailListBody.addEventListener('click', handleRowClick);
        }
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', handleSelectAllChange);
        }
        // Form submit listener is already on the form element

        // Load state and set initial UI *after* potential clearing
        loadSelectionFromStorage();
        updateFixedFooter(); // This sets visibility based on storage
        
        // Make functions globally available (required for the modal buttons)
        window.removeProcessedEmails = removeProcessedEmails;
        window.closeErrorMessage = closeErrorMessage;
    });
    
    // Add fade-out animation style
    document.head.insertAdjacentHTML('beforeend', `
        <style>
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            
            .fade-out {
                animation: fadeOut 0.5s forwards;
            }
        </style>
    `);
</script>
{% endblock %} 