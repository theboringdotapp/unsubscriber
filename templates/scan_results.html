{% extends 'base.html' %}

{% block title %}Scan Results - Gmail Unsubscriber{% endblock %}

{% block head_extra %}
<style>
    /* Checkmark animation styles */
    .checkmark-container {
        width: 80px;
        height: 80px;
        position: relative;
    }
    
    .checkmark {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: block;
        stroke-width: 2;
        stroke: #1a7f37;
        stroke-miterlimit: 10;
        box-shadow: inset 0px 0px 0px #1a7f37;
        animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
    }
    
    .checkmark-circle {
        stroke-dasharray: 166;
        stroke-dashoffset: 166;
        stroke-width: 2;
        stroke-miterlimit: 10;
        stroke: #1a7f37;
        fill: none;
        animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }
    
    .checkmark-check {
        transform-origin: 50% 50%;
        stroke-dasharray: 48;
        stroke-dashoffset: 48;
        animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }
    
    @keyframes stroke {
        100% {
            stroke-dashoffset: 0;
        }
    }
    
    @keyframes scale {
        0%, 100% {
            transform: none;
        }
        50% {
            transform: scale3d(1.1, 1.1, 1);
        }
    }
    
    @keyframes fill {
        100% {
            box-shadow: inset 0px 0px 0px 30px #eaffef;
        }
    }
    
    /* Modal overlay */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
    }
    
    .modal-hidden {
        display: none;
    }

    /* Sender group styles */
    .sender-group {
        border-left: 3px solid var(--sender-color, var(--accent-color));
        margin-bottom: 1rem;
    }
    
    .sender-header {
        padding: 0.75rem 1rem;
        background-color: rgba(var(--sender-color-rgb, var(--accent-color-rgb)), 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .sender-name-container {
        cursor: pointer;
    }
    
    .collapse-button {
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    
    .collapse-button:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    .sender-emails {
        overflow: hidden;
    }
    
    .sender-emails.collapsed {
        display: none;
    }
    
    .sender-name {
        transition: all 0.2s ease;
    }
    
    .sender-selected .sender-name {
        text-decoration: line-through;
        opacity: 0.7;
    }
    
    /* Content container with max-width */
    .content-container {
        max-width: 1280px;
        margin: 0 auto;
        width: 100%;
    }
    
    /* Tooltip fixes */
    .tooltip {
        position: relative;
        display: inline-flex;
        margin-left: 0.5rem;
    }
    
    .tooltip-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1.25rem;
        height: 1.25rem;
        border-radius: 50%;
        background-color: var(--text-secondary);
        color: white;
        font-size: 0.75rem;
        font-weight: bold;
        cursor: help;
    }
    
    .tooltip-text {
        visibility: hidden;
        width: 280px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        z-index: 10;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.875rem;
        font-weight: normal;
        text-align: left;
    }
    
    .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
    
    /* Arrow pointing down from tooltip */
    .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
    }
    
    /* Ensure tooltip container has overflow visible */
    .tooltip-container {
        position: relative;
        overflow: visible;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-container">
    <div class="card-bg rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-[var(--border-color)]">
            <h1 class="text-2xl font-semibold">Potential Unsubscribe Emails</h1>
            <div class="tooltip-container">
                <p class="text-sm text-[var(--text-secondary)] mt-2">
                    You only need to unsubscribe from one email per sender to be removed from their mailing list.
                    <span class="tooltip">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">
                            <strong>How unsubscribing works:</strong><br>
                            - You only need to unsubscribe once per sender to stop future emails<br>
                            - Selecting multiple emails from the same sender will only trigger one unsubscribe request<br>
                            - Archiving is optional and only affects emails already in your inbox
                        </span>
                    </span>
                </p>
            </div>
        </div>

        {% if emails %}
            <form class="action-form" id="unsubscribe-form" action="{{ url_for('unsubscribe_and_archive') }}" method="post" onsubmit="handleUnsubscribeSubmit(event)">
                <input type="hidden" name="final_email_ids" id="final-email-ids">
                <input type="hidden" name="final_unsubscribe_links" id="final-unsubscribe-links">
                <input type="hidden" name="should_archive" id="should-archive-input">

                <div class="px-6">
                    <div id="email-list-body">
                        {% for sender, sender_emails_list in emails.items() %}
                            <div class="sender-group" data-sender="{{ sender | escape }}">
                                <div class="sender-header">
                                    <div class="flex items-center sender-name-container" onclick="handleSenderNameClick(event, this)">
                                        <input type="checkbox" onclick="event.stopPropagation(); handleSenderCheckboxClick(this, '{{ sender | escape }}')" class="form-checkbox h-4 w-4 rounded text-[var(--accent-color)] focus:ring-[var(--accent-color)] sender-checkbox mr-3">
                                        <div>
                                            <span class="font-medium sender-name">{{ sender }}</span>
                                            <span class="ml-2 text-xs text-[var(--text-secondary)]">({{ sender_emails_list|length }} email{{ 's' if sender_emails_list|length > 1 else '' }})</span>
                                        </div>
                                    </div>
                                    <div class="collapse-button" onclick="toggleSenderGroup(this)">
                                        <svg class="h-5 w-5 text-[var(--text-secondary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="sender-emails">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-[var(--border-color)] table-fixed">
                                            <thead>
                                                <tr>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider w-16">
                                                        Select
                                                    </th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider">
                                                        Subject
                                                    </th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider w-32">
                                                        Unsubscribe Link
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-[var(--border-color)]">
                                                {% for email in sender_emails_list %}
                                                <tr data-sender="{{ sender | escape }}" data-id="{{ email.message_id }}" data-link="{{ email.link }}" class="hover:bg-[var(--hover-bg)] clickable-row">
                                                    <td class="px-6 py-4 whitespace-nowrap w-16">
                                                        <input type="checkbox" name="email_ids_page" value="{{ email.message_id }}" onclick="handleSingleCheckboxClick(this)" class="form-checkbox h-4 w-4 rounded text-[var(--accent-color)] focus:ring-[var(--accent-color)] item-checkbox">
                                                    </td>
                                                    <td class="px-6 py-4 text-sm text-[var(--text-primary)] truncate" title="{{ email.subject }}">
                                                        {{ email.subject }}
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-[var(--text-secondary)] w-32">
                                                        <a href="{{ email.link }}" target="_blank" class="text-[var(--accent-color)] hover:text-[var(--accent-hover)] hover:underline text-xs email-link" title="{{ email.link }}">Visit Link</a>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                {% if next_page_token %}
                <div class="px-6 py-4 text-right">
                    <a href="{{ url_for('scan_emails', token=next_page_token) }}" 
                       id="next-page-button" 
                       onclick="setLoading('next-page-button', 'Loading...')" 
                       class="glass-button inline-flex items-center px-4 py-2 text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--accent-color)]">
                        Next Page
                    </a>
                </div>
                {% endif %}
            </form>
        {% else %}
            <div class="px-6 py-4">
                <p class="text-[var(--text-secondary)]">No emails found with unsubscribe links in this batch or in your inbox.</p>
                 <a href="{{ url_for('index') }}" class="mt-4 inline-block text-[var(--accent-color)] hover:text-[var(--accent-hover)] hover:underline">Back to Home</a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal for unsubscribe results -->
<div id="result-modal" class="modal-overlay modal-hidden">
    <div id="unsubscribe-results" class="bg-white rounded-lg p-6 shadow-xl max-w-md w-full">
        <!-- Content will be replaced by the AJAX response -->
    </div>
</div>

<!-- Spacer div that will dynamically adjust its height when the action bar appears -->
<div id="footer-spacer" class="h-0 transition-all duration-200"></div>

{# Define the action bar content here, NOT hidden initially, to be moved by JS #}
{# The outer bar (#fixed-action-bar in base.html) controls visibility #}
<div id="fixed-action-bar-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-end flex-wrap gap-4">
    <div class="flex items-center mr-4">
        <input type="checkbox" id="archive-checkbox" class="form-checkbox h-4 w-4 rounded text-[var(--accent-color)] focus:ring-[var(--accent-color)]">
        <label for="archive-checkbox" class="ml-2 text-sm text-[var(--text-primary)]">Archive emails after unsubscribing</label>
        <span class="tooltip">
            <span class="tooltip-icon">?</span>
            <span class="tooltip-text">
                When checked, this will remove the emails from your inbox and archive them after unsubscribing. If unchecked, emails will remain in your inbox.
            </span>
        </span>
    </div>
    
    <button type="submit" 
            form="unsubscribe-form" 
            id="unsubscribe-button" 
            class="inline-flex items-center justify-center px-5 py-2 text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--accent-color)] bg-gradient-to-r from-[#0969da] to-[#8250df] text-white hover:translate-y-[-2px] hover:shadow-md transition-all duration-200" 
            disabled>
        <span id="button-action-text">Unsubscribe</span> <span id="selected-count" class="font-bold mx-1">0</span> <span id="selected-text">Emails</span>
    </button>
</div>

{% endblock %}

{% block scripts %}
<script>
    const storageKey = 'selectedEmails';
    let fixedActionBar = null;      // Initialize as null, find on DOMContentLoaded
    let actionBarContent = null;    // Initialize as null
    let selectedCountSpan = null;   // Initialize as null
    let selectAllCheckbox = null;   // Initialize as null
    let itemCheckboxes = [];        // Initialize as empty array
    let unsubscribeButton = null;   // Initialize as null
    let emailListBody = null;       // Initialize as null
    let footerSpacer = null;        // Initialize as null
    let resultModal = null;         // Initialize as null
    let archiveCheckbox = null;     // Initialize as null
    let processedEmailIds = new Set(); // Track processed emails

    // --- Storage Management ---
    function getSelectedEmails() {
        const stored = sessionStorage.getItem(storageKey);
        try {
            return stored ? JSON.parse(stored) : {}; // Store as {id: link}
        } catch (e) {
            console.error("Error parsing selectedEmails from sessionStorage:", e);
            return {}; // Return empty object on error
        }
    }

    function saveSelectedEmails(emails) {
        try {
            sessionStorage.setItem(storageKey, JSON.stringify(emails));
        } catch (e) {
            console.error("Error saving selectedEmails to sessionStorage:", e);
        }
    }

    function updateSelectionStorage(emailId, link, isSelected) {
        const selectedEmails = getSelectedEmails();
        if (isSelected) {
            selectedEmails[emailId] = link;
        } else {
            delete selectedEmails[emailId];
        }
        saveSelectedEmails(selectedEmails);
    }
    
    // --- Color Generation ---
    function stringToColor(str) {
        // Simple hash function
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        // Convert to a good hue value (0-360)
        const hue = Math.abs(hash % 360);
        
        // Use a fixed saturation and lightness for consistent, readable colors
        return `hsl(${hue}, 75%, 45%)`;
    }
    
    function getRGBComponents(color) {
        // For CSS variables, we need RGB components
        // Create a temporary div
        const temp = document.createElement('div');
        temp.style.color = color;
        document.body.appendChild(temp);
        
        // Get the computed style
        const style = window.getComputedStyle(temp);
        const rgb = style.color;
        
        document.body.removeChild(temp);
        
        // Extract RGB values using regex
        const match = rgb.match(/\d+/g);
        if (match && match.length >= 3) {
            return match.slice(0, 3).join(', ');
        }
        
        return '0, 0, 0'; // Default if something goes wrong
    }
    
    function applySenderColors() {
        document.querySelectorAll('.sender-group').forEach(group => {
            const sender = group.dataset.sender;
            if (!sender) return;
            
            const color = stringToColor(sender);
            const rgbComponents = getRGBComponents(color);
            
            group.style.setProperty('--sender-color', color);
            group.style.setProperty('--sender-color-rgb', rgbComponents);
        });
    }

    // --- UI Updates ---
    function updateFixedFooter() {
        console.log("updateFixedFooter called");
        if (!fixedActionBar || !unsubscribeButton) {
            console.error("Cannot update footer - fixedActionBar or unsubscribeButton not found.");
            return;
        }

        const selectedEmails = getSelectedEmails();
        const count = Object.keys(selectedEmails).length;
        console.log("Selected count:", count);

        // Get unique senders count
        const uniqueSenders = new Set();
        document.querySelectorAll('tr.clickable-row').forEach(row => {
            if (selectedEmails[row.dataset.id]) {
                uniqueSenders.add(row.dataset.sender);
            }
        });
        const senderCount = uniqueSenders.size;
        
        // Update the button text
        const selectedCountElement = document.getElementById('selected-count');
        if (selectedCountElement) {
            selectedCountElement.textContent = count;
        }
        
        // Update the text element based on count
        const selectedTextElement = document.getElementById('selected-text');
        if (selectedTextElement) {
            if (count === 1) {
                selectedTextElement.textContent = 'Email';
            } else {
                selectedTextElement.textContent = 'Emails';
            }
            
            // Add sender info if applicable
            if (senderCount > 0) {
                selectedTextElement.textContent += ` from ${senderCount} ${senderCount === 1 ? 'Sender' : 'Senders'}`;
            }
        }

        if (count > 0) {
            console.log("Showing fixed footer");
            fixedActionBar.classList.remove('hidden');
            unsubscribeButton.disabled = false;
            
            // Adjust the spacer height to match the action bar height
            if (footerSpacer) {
                // Get the height of the action bar
                const actionBarHeight = fixedActionBar.offsetHeight;
                footerSpacer.style.height = actionBarHeight + 'px';
            }
        } else {
            console.log("Hiding fixed footer");
            fixedActionBar.classList.add('hidden');
            unsubscribeButton.disabled = true;
            
            // Reset spacer height when action bar is hidden
            if (footerSpacer) {
                footerSpacer.style.height = '0';
            }
        }
        
        // Update button action text based on archive checkbox
        updateButtonActionText();
    }
    
    function updateButtonActionText() {
        const archiveCheckbox = document.getElementById('archive-checkbox');
        const buttonActionSpan = document.getElementById('button-action-text');
        
        if (buttonActionSpan && archiveCheckbox) {
            buttonActionSpan.textContent = archiveCheckbox.checked ? 'Unsubscribe & Archive' : 'Unsubscribe';
        }
    }

    function loadSelectionFromStorage() {
        console.log("loadSelectionFromStorage called");
        const selectedEmails = getSelectedEmails();
        
        // Check all item checkboxes that are in storage
        itemCheckboxes.forEach(checkbox => {
            const emailId = checkbox.value;
            checkbox.checked = selectedEmails.hasOwnProperty(emailId);
        });
        
        // Update sender checkboxes
        updateSenderCheckboxes();
    }
    
    function updateSenderCheckboxes() {
        // For each sender group, check if all emails are selected
        document.querySelectorAll('.sender-group').forEach(group => {
            const sender = group.dataset.sender;
            const checkboxes = group.querySelectorAll('.item-checkbox');
            const senderCheckbox = group.querySelector('.sender-checkbox');
            
            if (checkboxes.length > 0 && senderCheckbox) {
                let allChecked = true;
                let anyChecked = false;
                
                checkboxes.forEach(cb => {
                    if (cb.checked) {
                        anyChecked = true;
                    } else {
                        allChecked = false;
                    }
                });
                
                // Set sender checkbox state
                senderCheckbox.checked = allChecked;
                senderCheckbox.indeterminate = anyChecked && !allChecked;
                
                // Update strikethrough class
                const senderHeader = group.querySelector('.sender-header');
                if (senderHeader) {
                    if (allChecked) {
                        senderHeader.classList.add('sender-selected');
                    } else {
                        senderHeader.classList.remove('sender-selected');
                    }
                }
            }
        });
    }
    
    // --- Group Toggle ---
    function toggleSenderGroup(collapseButton) {
        const header = collapseButton.closest('.sender-header');
        const group = header.closest('.sender-group');
        const content = group.querySelector('.sender-emails');
        content.classList.toggle('collapsed');
        
        // Toggle arrow icon
        const arrow = collapseButton.querySelector('svg');
        if (content.classList.contains('collapsed')) {
            arrow.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>';
        } else {
            arrow.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
        }
    }
    
    // --- Handle sender name click ---
    function handleSenderNameClick(event, nameContainer) {
        // Stop propagation to prevent other handlers from firing
        event.stopPropagation();
        
        // Find the group and checkbox
        const group = nameContainer.closest('.sender-group');
        if (!group) {
            console.error("Could not find sender group");
            return;
        }
        
        const senderCheckbox = group.querySelector('.sender-checkbox');
        if (!senderCheckbox) {
            console.error("Could not find sender checkbox");
            return;
        }
        
        // Toggle the checkbox
        senderCheckbox.checked = !senderCheckbox.checked;
        
        // Get the sender from the data attribute
        const sender = group.dataset.sender;
        if (!sender) {
            console.error("Could not find sender data");
            return;
        }
        
        // Call the checkbox click handler
        handleSenderCheckboxClick(senderCheckbox, sender);
    }

    // --- Event Handlers ---
    function handleSingleCheckboxClick(checkbox) {
        console.log("handleSingleCheckboxClick called for:", checkbox.value, "Checked:", checkbox.checked);
        const row = checkbox.closest('tr');
        if (!row) {
            console.error("Could not find parent row for checkbox", checkbox);
            return;
        }
        const emailId = row.dataset.id;
        const link = row.dataset.link;
        if (!emailId || link === undefined) {
             console.error("Missing data-id or data-link on row", row);
             return;
        }

        updateSelectionStorage(emailId, link, checkbox.checked);
        updateFixedFooter(); // Update footer visibility and count
        updateSenderCheckboxes(); // Update sender checkboxes
    }
    
    function handleSenderCheckboxClick(checkbox, sender) {
        console.log("handleSenderCheckboxClick for sender:", sender);
        const group = checkbox.closest('.sender-group');
        const checkboxes = group.querySelectorAll('.item-checkbox');
        const checked = checkbox.checked;
        
        checkboxes.forEach(cb => {
            if (cb.checked !== checked) {
                cb.checked = checked;
                const row = cb.closest('tr');
                const emailId = row.dataset.id;
                const link = row.dataset.link;
                updateSelectionStorage(emailId, link, checked);
            }
        });
        
        updateFixedFooter(); // Update footer visibility and count
        updateSenderCheckboxes(); // Update strikethrough
    }

    // Row click handler
    function handleRowClick(event) {
        console.log("Row click listener fired. Target:", event.target);
        const row = event.target.closest('tr.clickable-row');
        if (!row) {
            console.log("Row click: Not inside a clickable row.");
            return;
        }
        console.log("Row click: Found row:", row);

        if (event.target.matches('input.item-checkbox, a.email-link, a.email-link *')) {
            console.log("Row click: Click was on checkbox or link, ignoring.");
            return;
        }

        const checkbox = row.querySelector('.item-checkbox');
        if (checkbox) {
            console.log("Row click: Found checkbox, toggling and calling handler.");
            checkbox.checked = !checkbox.checked;
            handleSingleCheckboxClick(checkbox); // Call the main handler
        } else {
            console.error("Row click: Could not find checkbox in row:", row);
        }
    }

    // Form submission handler - Now with AJAX
    function handleUnsubscribeSubmit(event) {
        event.preventDefault(); // Prevent normal form submission
        
        const selectedEmails = getSelectedEmails();
        const ids = Object.keys(selectedEmails);
        const links = Object.values(selectedEmails);
        const shouldArchive = document.getElementById('archive-checkbox').checked;

        document.getElementById('final-email-ids').value = ids.join(',');
        document.getElementById('final-unsubscribe-links').value = links.join(',,,,,'); // Use five commas as delimiter to avoid URL conflicts
        document.getElementById('should-archive-input').value = shouldArchive;

        if (ids.length === 0) {
            alert("Please select at least one email to unsubscribe.");
            return false;
        }
        
        // Store processed IDs for later removal
        ids.forEach(id => processedEmailIds.add(id));
        
        // Show loading state
        setLoading('unsubscribe-button', 'Unsubscribing...');
        
        // Show the modal immediately with a loading state
        if (resultModal) {
            document.getElementById('unsubscribe-results').innerHTML = `
                <div class="text-center">
                    <div class="inline-block rounded-full border-4 border-t-transparent border-[var(--accent-color)] border-solid h-12 w-12 animate-spin mb-4"></div>
                    <p class="text-gray-600">Processing your request...</p>
                </div>
            `;
            resultModal.classList.remove('modal-hidden');
        }
        
        // Submit the form with AJAX
        const form = document.getElementById('unsubscribe-form');
        const formData = new FormData(form);
        
        // Add a header to indicate this is an AJAX/HTMX request
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'HX-Request': 'true' // This tells the server it's an HTMX request
            }
        })
        .then(response => response.text())
        .then(html => {
            // Show the result modal with the response HTML
            if (resultModal) {
                document.getElementById('unsubscribe-results').innerHTML = html;
            }
            
            // Reset loading state
            if (unsubscribeButton) {
                hideLoading('unsubscribe-button');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            
            // Show error in the modal
            if (resultModal) {
                document.getElementById('unsubscribe-results').innerHTML = `
                    <div class="bg-white rounded-lg p-6 text-center flex flex-col items-center">
                        <div class="error-container mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-red-600 mb-2">Error</h3>
                        <p class="text-gray-600">An error occurred while processing your request.</p>
                        <button class="mt-4 px-4 py-2 bg-[var(--accent-color)] text-white rounded-md hover:bg-[var(--accent-hover)]" onclick="window.closeErrorMessage()">Close</button>
                    </div>
                `;
            }
            
            // Reset loading state
            if (unsubscribeButton) {
                hideLoading('unsubscribe-button');
            }
        });
    }
    
    // Function to remove processed emails from list
    function removeProcessedEmails() {
        console.log("removeProcessedEmails called");
        if (processedEmailIds.size === 0) {
            // No emails to remove
            if (resultModal) {
                resultModal.classList.add('modal-hidden');
            }
            return;
        }
        
        // Remove rows for processed emails
        processedEmailIds.forEach(emailId => {
            const row = document.querySelector(`tr[data-id="${emailId}"]`);
            if (row) {
                // Add animation class
                row.classList.add('fade-out');
                // Remove from the DOM after animation completes
                setTimeout(() => {
                    row.remove();
                    
                    // Check if sender group is now empty
                    const senderGroup = row.closest('.sender-group');
                    if (senderGroup && senderGroup.querySelectorAll('tr.clickable-row').length === 0) {
                        senderGroup.classList.add('fade-out');
                        setTimeout(() => {
                            senderGroup.remove();
                        }, 500);
                    }
                }, 500);
                
                // Also remove from storage
                const selectedEmails = getSelectedEmails();
                delete selectedEmails[emailId];
                saveSelectedEmails(selectedEmails);
            }
        });
        
        // Clear processed IDs
        processedEmailIds.clear();
        
        // Update button state
        updateFixedFooter();
        updateSenderCheckboxes();
        
        // Hide modal
        if (resultModal) {
            resultModal.classList.add('modal-hidden');
        }
    }
    
    // Function to close error message
    function closeErrorMessage() {
        console.log("closeErrorMessage called");
        if (resultModal) {
            resultModal.classList.add('modal-hidden');
        }
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOMContentLoaded event fired");
        console.log("Document Referrer:", document.referrer); // DEBUG

        // Find elements *after* DOM is loaded
        fixedActionBar = document.getElementById('fixed-action-bar');
        actionBarContent = document.getElementById('fixed-action-bar-content');
        footerSpacer = document.getElementById('footer-spacer');
        resultModal = document.getElementById('result-modal');
        archiveCheckbox = document.getElementById('archive-checkbox');
        // selectedCountSpan will be found inside updateFixedFooter
        itemCheckboxes = document.querySelectorAll('.item-checkbox');
        unsubscribeButton = document.getElementById('unsubscribe-button');
        emailListBody = document.getElementById('email-list-body');

        // Verify crucial elements needed for setup
        if (!fixedActionBar) console.error("#fixed-action-bar not found!");
        if (!actionBarContent) console.error("#fixed-action-bar-content not found!");
        if (!emailListBody) console.error("#email-list-body not found!");
        if (!footerSpacer) console.error("#footer-spacer not found!");
        if (!resultModal) console.error("#result-modal not found!");
        if (!archiveCheckbox) console.error("#archive-checkbox not found!");
        // unsubscribeButton check is implicitly done in updateFixedFooter

        // *** Check if this is a page refresh/initial load vs pagination ***
        const referrerUrl = document.referrer ? new URL(document.referrer) : null;
        const currentUrl = new URL(window.location.href);
        const isPagination = referrerUrl && referrerUrl.pathname === currentUrl.pathname; // Came from /scan

        if (!isPagination) {
            console.log("Referrer is not /scan or no referrer. Clearing selection storage.");
            sessionStorage.removeItem(storageKey);
        } else {
            console.log("Referrer is /scan. Assuming pagination, keeping selection storage.");
        }

        // Move content to fixed bar (do this before updating footer)
        if (fixedActionBar && actionBarContent && !fixedActionBar.contains(actionBarContent)) {
            console.log("Moving actionBarContent to fixedActionBar on load");
            fixedActionBar.appendChild(actionBarContent);
        } else if (fixedActionBar && fixedActionBar.contains(actionBarContent)) {
            console.log("actionBarContent already in fixedActionBar on load");
        }

        // Add event listeners
        if (emailListBody) {
            emailListBody.addEventListener('click', handleRowClick);
        }
        
        // Add event listener for archive checkbox
        if (archiveCheckbox) {
            archiveCheckbox.addEventListener('change', updateButtonActionText);
        }
        
        // Expand/collapse all sender groups on load
        document.querySelectorAll('.sender-emails').forEach(content => {
            content.classList.remove('collapsed');
        });
        
        // Apply custom colors to sender groups
        applySenderColors();

        // Load state and set initial UI *after* potential clearing
        loadSelectionFromStorage();
        updateFixedFooter(); // This sets visibility based on storage
        
        // Make functions globally available (required for the modal buttons)
        window.removeProcessedEmails = removeProcessedEmails;
        window.closeErrorMessage = closeErrorMessage;
        window.toggleSenderGroup = toggleSenderGroup;
        window.handleSenderNameClick = handleSenderNameClick;
    });
    
    // Add fade-out animation style
    document.head.insertAdjacentHTML('beforeend', `
        <style>
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            
            .fade-out {
                animation: fadeOut 0.5s forwards;
            }
        </style>
    `);
</script>
{% endblock %} 